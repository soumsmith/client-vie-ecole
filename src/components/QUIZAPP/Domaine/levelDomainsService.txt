import { useState, useEffect, useCallback } from 'react';
import { Badge } from 'rsuite';
import { FiTrash2, FiToggleLeft, FiToggleRight, FiLink, FiGraduationCap, FiFolder } from 'react-icons/fi';

// Hook personnalisé pour récupérer les données des associations niveau-domaine
export const useLevelDomainsData = (refreshTrigger = 0) => {
    const [levelDomains, setLevelDomains] = useState([]);
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState(null);

    const fetchLevelDomains = useCallback(async () => {
        setLoading(true);
        setError(null);
        
        try {
            const response = await fetch('level_domains_api.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'get_all'
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            
            if (result.success) {
                setLevelDomains(result.data || []);
            } else {
                throw new Error(result.message || 'Erreur lors de la récupération des associations');
            }
        } catch (err) {
            console.error('Erreur lors de la récupération des associations:', err);
            setError(err.message);
            setLevelDomains([]);
        } finally {
            setLoading(false);
        }
    }, []);

    useEffect(() => {
        fetchLevelDomains();
    }, [fetchLevelDomains, refreshTrigger]);

    const refetch = useCallback(() => {
        fetchLevelDomains();
    }, [fetchLevelDomains]);

    return { levelDomains, loading, error, refetch };
};

// Configuration du tableau des associations niveau-domaine
export const levelDomainsTableConfig = {
    columns: [
        {
            key: 'domain_name',
            label: 'Domaine',
            sortable: true,
            render: (value, item) => (
                <div style={{ display: 'flex', alignItems: 'center' }}>
                    <FiFolder style={{ marginRight: '8px', color: item.domain_color || '#007bff' }} />
                    <strong>{value}</strong>
                </div>
            )
        },
        {
            key: 'level_name',
            label: 'Niveau',
            sortable: true,
            render: (value, item) => (
                <div style={{ display: 'flex', alignItems: 'center' }}>
                    <FiGraduationCap style={{ marginRight: '8px', color: '#28a745' }} />
                    {value}
                </div>
            )
        },
        {
            key: 'category',
            label: 'Catégorie',
            sortable: true,
            render: (value, item) => {
                const categoryColors = {
                    'maternelle': 'pink',
                    'primaire': 'blue',
                    'college': 'green',
                    'lycee': 'orange',
                    'superieur': 'purple',
                    'formation_pro': 'cyan',
                    'formation_continue': 'yellow'
                };
                
                const categoryLabels = {
                    'maternelle': 'Maternelle',
                    'primaire': 'Primaire',
                    'college': 'Collège',
                    'lycee': 'Lycée',
                    'superieur': 'Supérieur',
                    'formation_pro': 'Formation Pro',
                    'formation_continue': 'Formation Continue'
                };

                return (
                    <Badge color={categoryColors[value] || 'gray'}>
                        {categoryLabels[value] || value}
                    </Badge>
                );
            }
        },
        {
            key: 'level_order',
            label: 'Ordre',
            sortable: true,
            render: (value, item) => (
                <Badge color="violet">{value}</Badge>
            )
        },
        {
            key: 'active',
            label: 'Statut',
            sortable: true,
            render: (value, item) => (
                <Badge color={value ? 'green' : 'red'}>
                    {value ? 'Actif' : 'Inactif'}
                </Badge>
            )
        },
        {
            key: 'created_at',
            label: 'Date de création',
            sortable: true,
            render: (value, item) => {
                if (!value) return '-';
                return new Date(value).toLocaleDateString('fr-FR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
            }
        }
    ],
    searchableFields: ['domain_name', 'level_name', 'category'],
    filterConfigs: [
        {
            key: 'category',
            label: 'Catégorie',
            type: 'select',
            options: [
                { label: 'Maternelle', value: 'maternelle' },
                { label: 'Primaire', value: 'primaire' },
                { label: 'Collège', value: 'college' },
                { label: 'Lycée', value: 'lycee' },
                { label: 'Supérieur', value: 'superieur' },
                { label: 'Formation Pro', value: 'formation_pro' },
                { label: 'Formation Continue', value: 'formation_continue' }
            ]
        },
        {
            key: 'active',
            label: 'Statut',
            type: 'select',
            options: [
                { label: 'Actif', value: 1 },
                { label: 'Inactif', value: 0 }
            ]
        }
    ],
    actions: [
        {
            key: 'toggle_active',
            label: (item) => item.active ? 'Désactiver' : 'Activer',
            icon: (item) => item.active ? <FiToggleRight /> : <FiToggleLeft />,
            color: (item) => item.active ? 'orange' : 'green',
            position: 'row'
        },
        {
            key: 'delete',
            label: 'Supprimer',
            icon: <FiTrash2 />,
            color: 'red',
            position: 'row',
            confirm: true
        }
    ]
};